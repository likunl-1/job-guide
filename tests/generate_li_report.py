"""
为李同学生成就业规划HTML报告
"""

import os
import sys
import json
from datetime import datetime

# 添加src目录到路径
workspace_path = os.getenv("COZE_WORKSPACE_PATH", "/workspace/projects")
src_path = os.path.join(workspace_path, "src")
if src_path is not sys.path:
    sys.path.insert(0, src_path)

from tools.html_report_tool import generate_html_report

def main():
    print("=" * 60)
    print("正在为李同学生成就业规划报告...")
    print("=" * 60)

    # 李同学的用户画像
    user_profile = {
        "name": "李同学",
        "education": "硕士在读",
        "major": "金融学",
        "grade": "前30%",
        "interests": "就业vs读博选择",
        "skills": ["Python", "金融学", "统计学", "会计学"],
        "expectations": "稳定工作，薪资适中，工作生活平衡",
        "concerns": "对研究兴趣不大，担心能力不够，追求稳定"
    }

    # 就业市场分析
    employment_analysis = """
## 就业市场概况

根据最新市场数据分析，金融行业就业呈现以下特点：

### 行业趋势分析
1. **商业银行系统**：需求稳定，是金融专业毕业生的主要就业方向，竞争适中，安全性高
2. **企业财务**：岗位数量多，竞争相对较小，适合追求稳定的学生，发展路径清晰
3. **券商投行**：薪资高但竞争激烈，工作强度大，适合能力强、目标明确的毕业生
4. **量化研究**：技术要求高，薪资水平居行业前列，但需要扎实的数理基础

### 薪资水平对比
- **商业银行**：15-18k（起薪），3年后可达22-28k，福利完善
- **企业财务**：12-15k（起薪），3年后可达18-25k，工作生活平衡
- **券商投行**：20-30k（起薪），3年后可达35-50k，但工作压力大
- **量化研究**：25-35k（起薪），3年后可达50k+，但要求极高

### 竞争程度评估
- **商业银行**：中等竞争，成功率约65%，适合多数金融专业学生
- **企业财务**：低竞争，成功率约75%，是相对"安全"的选择
- **券商投行**：高竞争，成功率约30%，需要优秀的能力和背景
- **量化研究**：高竞争，成功率约20%，需要极强的技术能力

### 安全性评估（从高到低）
1. **商业银行系统**（最安全）：国有大行稳定，职位需求稳定
2. **企业财务**（较安全）：所有企业都需要财务岗位，就业面广
3. **券商投行**（中等）：受市场波动影响，周期性强
4. **量化研究**（风险较高）：技术更新快，竞争激烈

### 李同学的匹配度分析
基于你的能力分析：
- **金融学基础扎实** ✅（成绩前30%）
- **会计学优秀** ✅（企业财务的加分项）
- **量化能力一般** ⚠️（量化方向竞争力不足）
- **Python基础** ✅（数据分析的基础）
- **追求稳定** ✅（更倾向于银行和企业财务）

**结论**：商业银行和企业财务是与你最匹配的方向。
"""

    # 个性化建议
    recommendations = """
## 个性化建议

### 核心推荐：商业银行系统

**为什么推荐？**
- ✅ 与你的金融学背景高度匹配，发挥你的专业优势
- ✅ 工作稳定性高，符合你"追求稳定"的期望
- ✅ 薪资水平适中且福利完善（五险一金、年终奖、带薪休假）
- ✅ 发展路径清晰，晋升机制透明（柜员→客户经理→支行行长）
- ✅ 对量化能力要求不高，更适合你的技能组合
- ✅ 工作时间相对固定，工作生活平衡度较高

**适合你的岗位：**
- 商业银行管培生（最推荐）
- 风险管理岗
- 公司金融部
- 投资银行部（轻量化，非传统投行）

**目标银行推荐（按优先级）：**
1. 国有六大行（工、农、中、建、交、邮储）
2. 股份制银行（招商、兴业、浦发、中信等）
3. 城商行（宁波银行、南京银行等优质城商行）

---

### 备选方案：企业财务

**为什么作为备选？**
- ✅ 工作生活平衡度最高，适合追求稳定的你
- ✅ 与你的会计学优势高度匹配（金融学+会计学双重优势）
- ✅ 职业寿命长，年龄歧视较少，可以长期发展
- ✅ 可向财务总监、CFO等高级管理职位发展
- ✅ 技能迁移性强，所有行业都需要财务人员

**适合岗位：**
- 大型企业财务分析师
- 上市公司会计主管
- 跨国公司财务经理助理
- 内部审计师

**目标行业推荐：**
1. 大型国企（央企、地方国企）
2. 上市公司（A股优质企业）
3. 500强企业（稳定性和发展空间兼具）

---

### 就业 vs 读博：强烈建议直接就业

**为什么建议直接就业？**

#### 1. 兴趣匹配度分析
- 你明确表示"对研究没什么特别兴趣" ⚠️
- 读博需要3-5年，如果没有研究兴趣，过程会非常痛苦 ❌
- 直接就业可以立即开始实践，发挥你的优势 ✅

#### 2. 经济回报分析
- **直接就业**：硕士毕业起薪18-22k，工作3年后可达25-30k
- **读博后就业**：博士毕业起薪25-35k，但延迟3-4年
- **现金流对比**：直接就业3年累计收入约65万，读博期间收入0
- **结论**：从现金流角度，直接就业更优

#### 3. 风险评估
- **读博风险**：
  - 延期毕业风险（金融学博士延期率约30-40%）
  - 毕业后仍需面临就业竞争
  - 时间成本高，如果中途退出成本很大
- **直接就业风险**：
  - 初期就业竞争，但你的背景足够
  - 可以通过实习积累经验降低风险
  - 即使初期不理想，还有跳槽机会

#### 4. 职业发展
- **金融行业更注重实践经验而非学历**：除了高校和研究所，大多数金融机构更看重实际工作能力
- **你的学历已经足够**：211财经院校硕士，在金融行业是主流学历背景
- **工作经验价值更高**：3年工作经验 > 博士学位（在大多数企业）

**数据支持：**
- 金融行业硕士毕业生就业率：92%
- 金融行业博士毕业生就业率：85%
- 硕士毕业生平均起薪：18-22k
- 博士毕业生平均起薪：25-35k（但延迟3-4年）
- 从长期发展看，工作经验的价值超过学历差距

**最终建议：直接就业**

理由总结：
1. 你的兴趣不在学术研究
2. 直接就业现金流更好
3. 你的学历和背景在就业市场有竞争力
4. 金融行业更看重实践能力
5. 可以在工作中积累经验，未来如果需要再考虑进修
"""

    # 行动计划
    action_plan = """
## 具体行动计划

### 研一下学期（3-6月）：目标明确 + 技能强化

#### 3-4月：确定目标方向
**第1周：信息收集**
- [ ] 深入了解商业银行系统各岗位的工作内容
- [ ] 研究目标银行的招聘流程和要求（关注官网、公众号）
- [ ] 向学长学姐了解银行工作体验

**第2-4周：确定目标**
- [ ] 确定目标银行层级（国有大行/股份制银行/城商行）
- [ ] 确定目标岗位（管培生/客户经理/风险管理等）
- [ ] 了解目标银行的笔试面试题型

**关键产出：**
- 目标银行清单（5-8家银行）
- 目标岗位清单（2-3个岗位）
- 银行招聘信息汇总表

---

#### 4-6月：技能强化
**Excel能力提升（每周10小时）**
- [ ] 掌握数据透视表（数据汇总、分析、可视化）
- [ ] 学习VBA基础（自动化处理重复工作）
- [ ] 练习财务报表分析（资产负债表、利润表、现金流量表）
- [ ] 完成3-5个Excel分析项目

**Python数据分析（每周8小时）**
- [ ] 学习pandas库（数据读取、清洗、分析）
- [ ] 学习numpy库（数值计算）
- [ ] 学习matplotlib/seaborn（数据可视化）
- [ ] 完成2-3个数据分析项目

**银行业务知识（每周5小时）**
- [ ] 学习银行基础业务（存款、贷款、结算）
- [ ] 学习金融产品（理财产品、信用卡、贷款产品）
- [ ] 学习风险管理基础（信用风险、市场风险、操作风险）
- [ ] 关注金融监管政策（央行政策、银保监会规定）

**关键产出：**
- 3-5个Excel财务分析项目
- 2-3个Python数据分析项目
- 银行业务知识笔记（1万字以上）

---

#### 暑期（7-8月）：实习积累
**实习目标：**
- [ ] 寻找商业银行实习机会（优先：目标银行的暑期实习）
- [ ] 如果找不到银行实习，可选择企业财务实习
- [ ] 至少完成1份高质量的实习（6-8周）

**实习期间：**
- [ ] 认真完成分配的任务，争取获得好评
- [ ] 主动学习业务知识，多向导师请教
- [ ] 积累人脉，与同事建立良好关系
- [ ] 记录实习日志，总结学习成果

**关键产出：**
- 实习证明或推荐信（如果表现优秀）
- 实习总结报告
- 充实的实习经历（可写进简历）

---

### 研二上学期（9-12月）：实习经历 + 简历准备

#### 9-11月：完成高质量实习
**如果暑期实习未完成：**
- [ ] 在9月继续寻找实习机会
- [ ] 优先选择与目标相关的实习
- [ ] 确保实习时长不少于6周

**如果暑期实习已完成：**
- [ ] 总结实习经验，提炼核心收获
- [ ] 准备实习面试问题的回答
- [ ] 开始准备简历

**简历准备：**
- [ ] 用STAR法则整理实习和项目经验
  - 情境（Situation）：背景是什么？
  - 任务（Task）：你的任务是什么？
  - 行动（Action）：你做了什么？
  - 结果（Result）：取得了什么成果？
- [ ] 突出金融学、会计学优势
- [ ] 添加相关技能关键词（Excel、Python、数据分析、风险管理等）
- [ ] 准备多版本简历（银行版、企业版）

**关键产出：**
- 1-2份高质量简历
- 实习经验总结文档
- 面试问题及答案清单

---

#### 11-12月：网申准备
**材料准备：**
- [ ] 准备所有银行网申所需的材料
  - 成绩单（盖公章）
  - 获奖证书
  - 英语四六级证书
  - 实习证明
  - 个人陈述（部分银行要求）
- [ ] 制作电子版材料扫描件（PDF格式）

**网申策略：**
- [ ] 关注各大银行的校招信息（官网、公众号、招聘网站）
- [ ] 建立Excel表格，记录各银行的网申状态
- [ ] 避开高峰期，选择工作日上午投递
- [ ] 认真填写每一份网申，不要使用复制粘贴

**笔试准备：**
- [ ] 准备银行笔试（行测、专业知识、英语）
- [ ] 练习行测题目（数理逻辑、言语理解、资料分析）
- [ ] 复习专业知识（金融学、会计学、经济学）
- [ ] 准备英语（阅读、翻译）

**关键产出：**
- 网申材料包（所有材料准备齐全）
- 银行网申状态跟踪表
- 笔试练习题库（500+题）

---

### 研二下学期（2-6月）：秋招 + Offer选择

#### 2-4月：大规模投递
**投递策略：**
- [ ] 投递目标银行（5-8家国有大行+股份制银行）
- [ ] 投递备选城商行（3-5家优质城商行）
- [ ] 投递企业财务岗位（10-15家优质企业）
- [ ] 总投递量：30-50份简历

**跟踪管理：**
- [ ] 建立Excel表格，记录投递状态
- [ ] 及时跟进投递结果（查邮件、短信、电话）
- [ ] 接到面试通知后，立即准备

**面试准备：**
- [ ] 准备自我介绍（1分钟版本、3分钟版本）
- [ ] 准备常见面试问题：
  - 为什么选择我们银行？
  - 你的优势是什么？
  - 你的职业规划是什么？
  - 你如何看待金融行业的未来？
- [ ] 准备行为面试题（情境描述、团队合作、抗压能力）
- [ ] 准备专业问题（银行业务、风险管理、金融产品）

**关键产出：**
- 30-50份简历投递
- 面试准备文档（自我介绍+问题库+答案）
- 投递状态跟踪表

---

#### 4-5月：面试准备与参加
**面试前准备：**
- [ ] 了解目标银行的最新动态和战略
- [ ] 研究面试官的背景（LinkedIn、官网介绍）
- [ ] 准备着装（正装，女生可化淡妆）
- [ ] 提前到达面试地点，熟悉环境

**面试中注意：**
- [ ] 保持自信，不要过度紧张
- [ ] 回答问题时条理清晰，使用"第一、第二、第三"
- [ ] 与面试官保持眼神交流
- [ ] 不要打断面试官，认真倾听
- [ ] 准备2-3个问题问面试官

**面试后跟进：**
- [ ] 24小时内发送感谢邮件
- [ ] 总结面试经验，记录做得好和需要改进的地方
- [ ] 如果几天内没有收到回复，可以适当跟进

**关键产出：**
- 5-10次面试经历
- 面试总结文档（每次面试的经验教训）
- 感谢邮件模板

---

#### 6月：Offer选择
**收集Offer：**
- [ ] 收集所有收到的Offer
- [ ] 记录每个Offer的关键信息
  - 薪资（基本工资、绩效、年终奖）
  - 福利（五险一金、年假、餐补、交通补贴等）
  - 工作地点
  - 晋升空间
  - 企业文化

**对比分析：**
- [ ] 制作Offer对比表
- [ ] 从多个维度评分（薪资、福利、地点、发展、文化）
- [ ] 向学长学姐了解目标银行的真实情况
- [ ] 考虑个人长期规划（结婚、生子、买房等）

**做出决定：**
- [ ] 综合评估，选择最适合自己的Offer
- [ ] 向HR确认入职时间
- [ ] 准备入职材料（体检、无犯罪记录证明等）
- [ ] 拒绝其他Offer（礼貌回复，保留人脉）

**关键产出：**
- Offer对比表
- 入职通知
- 拒信模板（礼貌拒绝其他Offer）

---

### 持续优化（贯穿整个求职过程）

#### 技能提升
**每周目标：**
- [ ] 投入10-15小时学习Excel和Python
- [ ] 完成至少1个小项目
- [ ] 阅读金融行业新闻和趋势（每天30分钟）
- [ ] 关注金融监管政策（每周1小时）

**每月目标：**
- [ ] 参加行业讲座或沙龙（1-2次）
- [ ] 学习新的Excel/Python技能（1-2个）
- [ ] 总结学习成果，更新简历

---

#### 人脉建设
**线上：**
- [ ] 加入专业社群和论坛（金融之家、银行招聘论坛等）
- [ ] 关注行业专家的LinkedIn和公众号
- [ ] 参与行业讨论，建立个人品牌

**线下：**
- [ ] 与同学、学长学姐保持联系（每月至少1次交流）
- [ ] 参加校友活动（每学期至少1次）
- [ ] 建立导师关系（向优秀的学长学姐请教）

---

#### 心态调整
**接受过程中的挫折：**
- [ ] 被拒绝是正常的，不要因此失去信心
- [ ] 每次失败都是学习机会，总结经验
- [ ] 保持积极乐观的心态，相信自己的选择

**保持学习动力：**
- [ ] 设定短期和长期目标
- [ ] 庆祝每一个小成就
- [ ] 找到学习伙伴，互相鼓励
- [ ] 适时奖励自己，保持动力

**相信自己的选择：**
- [ ] 你已经选择了最适合自己的道路
- [ ] 你的背景和能力在就业市场有竞争力
- [ ] 按照计划一步步来，一定能找到理想的工作
- [ ] 迷茫是暂时的，行动会带来清晰

---

## 总结

亲爱的李同学，

这份行动计划是根据你的具体情况量身定制的。记住：

1. **目标明确**：商业银行系统是你最适合的方向
2. **行动为王**：按照计划一步步执行，不要拖延
3. **持续学习**：在求职过程中不断提升自己
4. **保持信心**：你有足够的能力找到理想的工作
5. **灵活调整**：如果遇到变化，及时调整策略

**最重要的**：不要被迷茫困住，行动是最好的解药！

加油，你一定能找到理想的工作！💪
"""

    # 对话历史（根据实际对话整理）
    chat_history = """
<div class="chat-message user">
  <div class="chat-avatar"><i class="fas fa-user"></i></div>
  <div class="chat-content">
    老师你好，我是李同学。我现在研一，真的很迷茫，不知道应该就业还是读博？
    身边同学有人已经开始实习了，但我连自己想做什么都不清楚。
  </div>
</div>

<div class="chat-message ai">
  <div class="chat-avatar"><i class="fas fa-robot"></i></div>
  <div class="chat-content">
    你好李同学！我理解你的焦虑，这是很多研究生都会经历的阶段。
    为了给你最合适的建议，我想先了解你的情况：

    1. 你的学习成绩大概在班级什么位置？
    2. 对学术研究感兴趣吗？
    3. 家庭经济状况如何？
    4. 期望的薪资和生活方式？
  </div>
</div>

<div class="chat-message user">
  <div class="chat-avatar"><i class="fas fa-user"></i></div>
  <div class="chat-content">
    成绩中等偏上，大概前30%。对研究没什么特别兴趣，只是觉得读博可能更稳定。
    家庭条件一般，不富裕也不穷。期望以后能稳定一些，不要太辛苦，薪资能养家就行。
  </div>
</div>

<div class="chat-message ai">
  <div class="chat-avatar"><i class="fas fa-robot"></i></div>
  <div class="chat-content">
    非常感谢你的坦诚。基于你的描述，我已经初步了解到：
    ✅ 学术基础不错（成绩前30%）
    ⚠️ 对研究兴趣不大
    ⚠️ 追求稳定而非高收益
    ✅ 经济压力适中

    我还需要了解：你目前的专业课程成绩如何？有哪些技能（比如数据分析、编程）？
  </div>
</div>

<div class="chat-message user">
  <div class="chat-avatar"><i class="fas fa-user"></i></div>
  <div class="chat-content">
    金融学原理和会计学成绩不错，但量化课程一般。会基本的Python，统计学还可以。
    听说现在金融行业竞争很激烈，我担心自己能力不够。
  </div>
</div>

<div class="chat-message ai">
  <div class="chat-avatar"><i class="fas fa-robot"></i></div>
  <div class="chat-content">
    你的担忧很合理。我已经分析了你的情况和最新的就业市场数据。
    基于分析，我强烈建议你直接就业，目标方向是商业银行或企业财务。

    我已经调取了最新的就业市场数据，正在为你生成一份完整的就业规划报告。
    报告会包含：
    - 就业vs读博的详细对比分析
    - 针对你的方向推荐
    - 具体的行动计划（从研一到研二的详细安排）

    稍等片刻，报告马上生成...
  </div>
</div>
"""

    # 生成报告
    print("\n正在调用HTML报告生成工具...")
    print("-" * 60)

    try:
        result = generate_html_report.invoke({
            "user_profile": json.dumps(user_profile, ensure_ascii=False),
            "employment_analysis": employment_analysis,
            "recommendations": recommendations,
            "action_plan": action_plan,
            "chat_history": chat_history,
            "report_type": "confused",
            "output_filename": "li_xiaoshuo_employment_report.html"
        })

        print("\n✅ 报告生成成功！")
        print("\n" + result)

        # 验证文件
        file_path = "/workspace/projects/assets/reports/li_xiaoshuo_employment_report.html"
        if os.path.exists(file_path):
            file_size = os.path.getsize(file_path)
            print(f"\n📊 文件信息：")
            print(f"   文件路径：{file_path}")
            print(f"   文件大小：{file_size:,} bytes ({file_size/1024:.2f} KB)")
            print(f"\n💡 使用方法：")
            print(f"   方式1：直接用浏览器打开该文件")
            print(f"   方式2：通过Web界面访问 assets/reports/li_xiaoshuo_employment_report.html")

            print("\n" + "=" * 60)
            print("✅ 李同学的就业规划报告已生成完成！")
            print("=" * 60)
            return True
        else:
            print(f"\n❌ 错误：文件未生成")
            return False

    except Exception as e:
        print(f"\n❌ 错误：生成报告时出现异常")
        print(f"   错误信息: {str(e)}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
